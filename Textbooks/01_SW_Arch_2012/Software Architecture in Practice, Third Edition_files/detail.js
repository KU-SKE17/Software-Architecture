/*! Copyright (c) 2012 Safari Books Online, LLC. All rights reserved.*/

jQuery.retryAjax=function(e){var t,i=jQuery;return e.tryCount=e.tryCount?e.tryCount:0,e.retryLimit=e.retryLimit?e.retryLimit:2,e.retryDelay=e.retryDelay?e.retryDelay:1e3,t=e.error?e.error:function(){},e.error=function(){if(this.tryCount++,this.tryCount<=this.retryLimit){this.tryCount===this.retryLimit&&(this.error=t);var e=this;return setTimeout(function(){i.ajax(e)},this.retryDelay),!0}return!0},i.ajax(e)},define("src/jquery.retryAjax",["jquery"],function(e){return function(){var t;return t||e.jQuery.retryAjax}}(this)),define("heron/rec-pod",["require","jquery","lodash","backbone","text!heron/templates/feedback.html","src/jquery.retryAjax"],function(e){var t,i=e("jquery"),r=e("lodash"),a=e("backbone"),n="/r/add-new-recommendation/",s=e("text!heron/templates/feedback.html"),o="/api/v1/rejected/",c="/api/v1/queue-simple/";return e("src/jquery.retryAjax"),t=a.View.extend({el:"body",events:{"click .rec-fav":"toggleQueue","click .rec-delete":"rejectItem","click .js-toc-link":"trackTOCClick","click .js-cover":"trackCoverClick","click .chapter-title":"trackBitTitleClick","click .book-title":"trackBookTitleClick","click .js-addone-button":"getNewRecommendation"},initialize:function(){r.bindAll(this,"addRecommendation"),a.on("queue",this.toggleQueueClass,this),this.isHomecard=i("body").hasClass("homepage"),this.subscriptionStatus=i("article").data("subscription"),this.subscriptionStatus&&(this.inactive="inactive"===this.subscriptionStatus)},getLI:function(e){return this.$(e).closest("li")},getLIByData:function(e){return this.$('li[data-api-url="'+e+'"]')},getByte:function(e){return this.$(e).parents(".js-card")},getItemData:function(e){return{apiURL:this.getLI(e).attr("data-api-url")||this.getLI(e).find(".js-bit").attr("data-api-url"),service:this.getLI(e).attr("data-service")||t.UNDEFINED_RECOMMENDATION_SERVICE}},getBitRecommendationServiceName:function(e){var t=this.getItemData(e);return t.service},doAjax:function(e){return{type:e.type,contentType:"application/json",dataType:e.dataType,data:e.transport,url:e.url,timeout:2e3}},rejectItem:function(e){var t,r,n=this.getLI(e.target),s=this.getAnalyticsRank(n),c=this.getItemData(e.currentTarget).apiURL,u=this,l=this.isHomecard,d=this.isHomecard?"Home":"Recommendation";return this.inactive?void this.showFeedback(e,"recommended","expired"):(t={transport:JSON.stringify([c]),type:"POST",url:o,dataType:"json"},n.slideUp("fast",function(){n.remove(),l&&u.getNewRecommendation()}),r=i.ajax(this.doAjax(t)),void r.done(function(){a.trigger("track",["send","event",d,"Reject",u.resourceComponents(c,{ga:!0}),s])}))},getContainer:function(e){return e.closest(".js-bitlist")},getNumRecommendationsInList:function(e){return e.find(".format-book, .format-video").length},getCategory:function(e){var t={recommendations:"Recommendation","star-whole-title":"Title Detail","js-reader":"Reader Navigation","js-starred":"Starred","js-recent":"Recent","js-related":"Related Content","js-homelist":"Home","js-explore":"Explore","js-search":"Search","js-topics":"Topic"};return r.find(t,function(t,i){return e.hasClass(i)})},getHomeLabel:function(e){var t={"js-last-viewed":"Last Viewed","js-recommended":"Recommended","js-popular":"Popular","js-short":"Short and Sweet","js-finish":"Finish Up","js-news":"News"};return r.find(t,function(t,i){return e.hasClass(i)})},resourceComponents:function(e,t){var i=e.split("/"),r=i.pop(),a=i[0]||i[4];return t=t||!1,""===r?i.pop():t?a+":"+r:{archive:a,full_path:r}},queueSuccess:function(e,t){var r,n,s=this.$(e.currentTarget),o=this.getContainer(s);a.trigger("queue",t.apiURL,t.isRemove?{remove:!0}:null),this.updateTitleText(s,t.isRemove),n=o.hasClass("js-homelist")?this.getHomeLabel(o):this.resourceComponents(t.apiURL,{ga:!0}),t.isRemove?(r=t.isWholeTitle?"Remove Whole Title from Queue":"Remove From Queue",this.trackInteraction(i(e.currentTarget),r,{store:!1},n,{queue:!0}),this.showFeedback(e,"queue","removed",t.format)):(r=t.isWholeTitle?"Queue Whole Title":"Queue",this.trackInteraction(i(e.currentTarget),r,{store:!1},n,{queue:!0}),this.showFeedback(e,"queue","added",t.format))},queueFail:function(e,t){this.showFeedback(e,"queue","error",t)},toggleQueue:function(e){var t,r,a=this,n=this.$(e.currentTarget),s=n.attr("data-req"),o={format:n.parent().attr("data-format"),isWholeTitle:this.getLI(n).attr("data-is-whole-book"),isRemove:n.hasClass("active"),apiURL:this.getItemData(e.currentTarget).apiURL},u={transport:JSON.stringify([o.apiURL]),type:o.isRemove?"DELETE":"POST",url:c,dataType:"text"};return this.inactive?void this.showFeedback(e,"queue","expired"):(s&&s.abort(),t=i.ajax(this.doAjax(u)),n.data("req",t),t.fail(function(){r=i.retryAjax(a.doAjax(u)),r.done(function(){a.queueSuccess(e,o)}),r.fail(function(){a.queueFail(e,o.format)})}),t.done(function(){a.queueSuccess(e,o)}),void t.always(function(){n.data("req",null)}))},updateTitleText:function(e,t){var i="Add to Queue",r="Remove from Queue",a=t?i:r;e.attr("title",a),e.attr("aria-label",a)},toggleQueueClass:function(e,t,i){var r;if(i)r=this.$(".rec-fav").toggleClass("active",!t).parent(),this.updateDataAttrs(e,r);else{if(r=this.getLIByData(e),!r.length)return;r.find(".rec-fav").toggleClass("active",!t)}},showFeedback:function(e,t,i,a){var n,o,c,u,l="error"===i,d="added"===i?"added to":"removed from",h="added"===i?"Remove this whole ":"Queue this whole ",m="added"===i?"Added to":"Removed from",f="queue"===t?"Queueing":"Deleting",g=this.getLI(e.target),p=g.find(".js-queue-whole-text"),v=g.hasClass("js-bit")||g.data("is-whole-book"),y=this.inactive&&"recommended"===t?"ss-ban":"ss-queue";v&&(l?u="Sorry, there was an error updating your Queue. Please try again.":this.inactive?("canceled"===this.subscriptionStatus&&(i="canceled"),u=f+" is disabled for your account."):a?(u="This "+a+" has been "+d+" your queue",c=h+a):u=m+" your queue",n={msg:u,css_class:y,state:i},p.length&&p.text(c),o=r.template(s),u=o(n),g.prepend(u).find(".js-feedback").fadeIn(),setTimeout(function(){g.find(".js-feedback").fadeOut().promise().done(function(){this.remove()})},1200))},updateDataAttrs:function(e,t){t.attr("data-api-url",e)},getNewRecommendation:function(){var e,t=n+"?limit=1",r=this.resourceComponents(t);e={transport:JSON.stringify(r),type:"POST",url:t,dataType:"json"},i.ajax(this.doAjax(e)).always(this.addRecommendation)},addRecommendation:function(e){var t=i(e.responseText).find("li.format-book, li.format-video"),r=this.isHomecard,a=r?t.find(".info").parents("li.format-book, li.format-video"):t;t.length&&(r?a.hide().prependTo(this.$(".t-recommended .js-bitlist")).slideDown("fast"):(t.hide().prependTo(this.$(".js-bitlist")).slideDown("fast"),t.addClass("open")))},getAnalyticsRank:function(e){var t,r,a=i(e);return a.length?(t=a.closest("ul").children(),r=t.index(a[0]),-1===r?r:r+1):-1},trackBitTitleClick:function(e){var t,i,r=this.$(e.currentTarget),a=this.getContainer(r),n="Read";a.hasClass("bytelist")&&(t=r.closest(".js-starting-bits").length?"Start Here":r.closest(".js-match-bits").length?"Best Matches":"Most Popular"),a.hasClass("js-homelist")&&(t=this.getHomeLabel(a),n="Internal"),a.hasClass("recommendations")&&(i=this.getLI(r),t=this.getBitRecommendationServiceName(i)),this.trackInteraction(r,n,{store:!0},t)},trackCoverClick:function(e){this.trackInteraction(i(e.currentTarget),"View Title Detail",{store:!0},"Image")},trackTOCClick:function(e){this.trackInteraction(i(e.currentTarget),"View Title Detail",{store:!0},"TOC")},trackBookTitleClick:function(e){var t,i,r=this.$(e.currentTarget),a=this.getContainer(r),n="View Title Detail";a.hasClass("bytelist")&&(t="Title"),a.hasClass("js-homelist")&&(t=this.getHomeLabel(a),n="Internal"),a.hasClass("recommendations")&&(i=this.getLI(r),t=this.getBitRecommendationServiceName(i)),this.trackInteraction(r,n,{store:!0},t)},trackInteraction:function(e,t,i,r,n){var s,o,c=this.getCategory(this.getContainer(e)),u=this.$(e).closest(".js-card"),l=this.getItemData(e).apiURL,d=this.getAnalyticsRank(u);s={location:document.location.toString(),title:document.title},r||(r=this.resourceComponents(l,{ga:!0})),o=["send","event",c,t,r],d>=0&&o.push(d),n||o.push(s),a.trigger("track",o,i)}},{UNDEFINED_RECOMMENDATION_SERVICE:"undefined"})}),require(["_config"],function(){define("pages/detail",["jquery","heron/app-shared","heron/recently-viewed","heron/rec-pod","ratings/main","pages/radio.shim"],function(e,t,i,r,a){e(function(){var n=new a;new r,e("#js-ratings-modal-region").length&&n.start({reviewSelector:".review-report",attachedTo:"title page"}),i.add(e("html").data("archive").toString()),t.init()})})}),require(["pages/detail"],function(){});